name: Push Summary to Google Drive

# 워크플로우 비활성화 (필요시 주석 해제)
# on:
#   push:
#     branches: [main]
on:
  workflow_dispatch:  # 수동 실행만 가능하도록 변경

jobs:
  drive-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout with full history
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install rclone
        run: |
          sudo apt update && sudo apt install -y rclone

      - name: Configure rclone with OAuth credentials
        run: |
          # OAuth 2.0을 사용하여 개인 Google 계정 권한으로 업로드
          echo "🔐 OAuth 2.0 모드로 설정 중..."
          
          # 환경 변수 확인 (디버깅용)
          echo "📋 환경 변수 확인:"
          echo "  CLIENT_ID 길이: ${#GDRIVE_CLIENT_ID}"
          echo "  CLIENT_SECRET 길이: ${#GDRIVE_CLIENT_SECRET}"
          echo "  REFRESH_TOKEN 길이: ${#GDRIVE_REFRESH_TOKEN}"
          echo "  REFRESH_TOKEN 시작: ${GDRIVE_REFRESH_TOKEN:0:10}..."
          echo "  FOLDER_ID: $GDRIVE_FOLDER_ID"
          
          # 리프레시 토큰이 비어있는지 확인
          if [ -z "$GDRIVE_REFRESH_TOKEN" ]; then
            echo "❌ 오류: GDRIVE_REFRESH_TOKEN이 설정되지 않았습니다!"
            echo "📝 GitHub Secrets에 GDRIVE_REFRESH_TOKEN을 추가하세요."
            exit 1
          fi
          
          # 리프레시 토큰이 CLIENT_SECRET과 같은지 확인 (잘못 설정된 경우)
          if [ "$GDRIVE_REFRESH_TOKEN" = "$GDRIVE_CLIENT_SECRET" ]; then
            echo "❌ 오류: REFRESH_TOKEN이 CLIENT_SECRET과 같습니다!"
            echo "📝 GitHub Secrets에서 GDRIVE_REFRESH_TOKEN을 올바른 값으로 설정하세요."
            echo "   리프레시 토큰은 '1//'로 시작하는 긴 문자열이어야 합니다."
            exit 1
          fi
          
          # 리프레시 토큰이 올바른 형식인지 확인 (1//로 시작해야 함)
          if [[ ! "$GDRIVE_REFRESH_TOKEN" =~ ^1// ]]; then
            echo "❌ 오류: REFRESH_TOKEN 형식이 올바르지 않습니다!"
            echo "📝 리프레시 토큰은 '1//'로 시작해야 합니다."
            echo "   현재 값 시작: ${GDRIVE_REFRESH_TOKEN:0:10}..."
            exit 1
          fi
          
          # rclone 설정 디렉토리 생성
          mkdir -p ~/.config/rclone
          
          # Python을 사용하여 토큰 JSON 생성 (YAML 파서 충돌 방지)
          echo "📝 토큰 JSON 생성 중..."
          TOKEN_JSON=$(python3 << PYTHON_EOF
import json
import os
token = {
    "access_token": "",
    "token_type": "Bearer",
    "refresh_token": os.environ["GDRIVE_REFRESH_TOKEN"],
    "expiry": "2000-01-01T00:00:00Z"
}
print(json.dumps(token))
PYTHON_EOF
)
          
          # rclone 설정 생성
          echo "📝 rclone 설정 생성 중..."
          rclone config create gdrive drive \
            client_id="$GDRIVE_CLIENT_ID" \
            client_secret="$GDRIVE_CLIENT_SECRET" \
            token="$TOKEN_JSON" \
            scope=drive.file \
            root_folder_id="$GDRIVE_FOLDER_ID" \
            --non-interactive
          
          echo "✅ OAuth 설정 완료"

      - name: Generate summary files (overwrite with details)
        run: |
          git log --pretty=format:"%h - %s (%an, %ad)" --date=short > Myteamdashboard_summary.txt
          git log --pretty=format:"%h - %s (%an, %ad)" --date=short > Myteamdashboard_summary_detail.txt
          echo -e "\n\n# 전체 코드 diff" >> Myteamdashboard_summary_detail.txt
          git diff $(git rev-list --max-parents=0 HEAD)..HEAD >> Myteamdashboard_summary_detail.txt

      - name: Upload summary file to Google Drive
        run: |
          rclone -v copyto Myteamdashboard_summary.txt gdrive:Myteamdashboard_summary.txt || {
            echo "❌ 업로드 실패: Service Account에 폴더 접근 권한이 있는지 확인하세요."
            echo "📝 해결 방법:"
            echo "   1. Google Drive에서 폴더를 열고 '공유' 클릭"
            echo "   2. Service Account 이메일 주소를 공유자로 추가 (편집자 권한)"
            echo "   3. 또는 Shared Drive를 사용하는 경우 GDRIVE_TEAM_DRIVE_ID secret을 설정하세요"
            exit 1
          }

      - name: Upload detailed summary file to Google Drive
        run: |
          rclone -v copyto Myteamdashboard_summary_detail.txt gdrive:Myteamdashboard_summary_detail.txt || {
            echo "❌ 상세 요약 파일 업로드 실패"
            exit 1
          }

    env:
      GDRIVE_CLIENT_ID: ${{ secrets.GDRIVE_CLIENT_ID }}
      GDRIVE_CLIENT_SECRET: ${{ secrets.GDRIVE_CLIENT_SECRET }}
      GDRIVE_REFRESH_TOKEN: ${{ secrets.GDRIVE_REFRESH_TOKEN }}
      GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
