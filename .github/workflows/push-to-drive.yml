name: Push Summary to Google Drive

on:
  push:
    branches: [main]

jobs:
  drive-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout with full history
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install rclone
        run: |
          sudo apt update && sudo apt install -y rclone

      - name: Configure rclone with service account credentials
        run: |
          echo "$GDRIVE_CREDENTIALS" > credentials.json
          rclone config create gdrive drive scope=drive service_account_file=credentials.json root_folder_id=${{ secrets.GDRIVE_FOLDER_ID }}

      - name: Check for existing summary file
        id: check
        run: |
          if rclone ls gdrive:Myteamdashboard_summary.txt > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_ENV
            rclone copyto gdrive:Myteamdashboard_summary.txt Myteamdashboard_summary.txt
            rclone copyto gdrive:Myteamdashboard_summary_detail.txt Myteamdashboard_summary_detail.txt
          else
            echo "exists=false" >> $GITHUB_ENV
          fi

      - name: Generate summary files (smart append or overwrite)
        run: |
          if [ "$exists" = "false" ] || [ ! -f Myteamdashboard_summary.txt ]; then
            # ìµœì´ˆ ì‹¤í–‰: ì „ì²´ ë¡œê·¸ ìƒì„±
            git log --pretty=format:"%h - %s (%an, %ad)" --date=short > Myteamdashboard_summary.txt
          else
            LAST_HASH=$(tail -n 1 Myteamdashboard_summary.txt | awk '{print $1}')
            HEAD_HASH=$(git log -1 --pretty=format:"%h")
            if git merge-base --is-ancestor $LAST_HASH $HEAD_HASH; then
              if [ "$LAST_HASH" = "$HEAD_HASH" ]; then
                echo "Already up to date."
              else
                git log ${LAST_HASH}..HEAD --pretty=format:"%h - %s (%an, %ad)" --date=short | grep -v "^$" >> Myteamdashboard_summary.txt
              fi
            else
              # LAST_HASHê°€ HEADì— í¬í•¨ë˜ì§€ ì•Šìœ¼ë©´ ì „ì²´ ë¡œê·¸ë¡œ ë®ì–´ì“°ê¸°
              git log --pretty=format:"%h - %s (%an, %ad)" --date=short > Myteamdashboard_summary.txt
            fi
          fi

          # detail íŒŒì¼ì€ ê¸°ì¡´ ë°©ì‹ ìœ ì§€
          if [ "$exists" = "true" ]; then
            echo -e "\n\n# $(date '+%Y-%m-%d %H:%M') ë³€ê²½ë¶„" >> Myteamdashboard_summary_detail.txt
            git log -1 --pretty=format:"%h - %s (%an, %ad)" --date=short >> Myteamdashboard_summary_detail.txt
            echo -e "\nChanges:" >> Myteamdashboard_summary_detail.txt
            git diff HEAD^ >> Myteamdashboard_summary_detail.txt
          else
            echo "ðŸ“Œ ìµœì´ˆ ì‹¤í–‰: ì „ì²´ ì»¤ë°‹ ë‚´ì—­ ìƒì„±" > Myteamdashboard_summary_detail.txt
            git log --pretty=format:"%h - %s (%an, %ad)" --date=short >> Myteamdashboard_summary_detail.txt
            echo -e "\n\n# ì „ì²´ ì½”ë“œ diff" >> Myteamdashboard_summary_detail.txt
            git diff $(git rev-list --max-parents=0 HEAD)..HEAD >> Myteamdashboard_summary_detail.txt
          fi

      - name: Upload summary file to Google Drive
        run: rclone -v copyto Myteamdashboard_summary.txt gdrive:Myteamdashboard_summary.txt

      - name: Upload detailed summary file to Google Drive
        run: rclone -v copyto Myteamdashboard_summary_detail.txt gdrive:Myteamdashboard_summary_detail.txt

    env:
      GDRIVE_CREDENTIALS: ${{ secrets.GDRIVE_CREDENTIALS }}
      GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
