name: Push Summary to Google Drive

# ì›Œí¬í”Œë¡œìš° ë¹„í™œì„±í™” (í•„ìš”ì‹œ ì£¼ì„ í•´ì œ)
# on:
#   push:
#     branches: [main]
on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë§Œ ê°€ëŠ¥í•˜ë„ë¡ ë³€ê²½

jobs:
  drive-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout with full history
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install rclone
        run: |
          sudo apt update && sudo apt install -y rclone

      - name: Configure rclone with OAuth credentials
        run: |
          # OAuth 2.0ì„ ì‚¬ìš©í•˜ì—¬ ê°œì¸ Google ê³„ì • ê¶Œí•œìœ¼ë¡œ ì—…ë¡œë“œ
          echo "ğŸ” OAuth 2.0 ëª¨ë“œë¡œ ì„¤ì • ì¤‘..."
          
          # í™˜ê²½ ë³€ìˆ˜ í™•ì¸ (ë³´ì•ˆ: ê¸¸ì´ë§Œ í™•ì¸)
          echo "ğŸ“‹ í™˜ê²½ ë³€ìˆ˜ í™•ì¸:"
          echo "  CLIENT_ID ê¸¸ì´: ${#GDRIVE_CLIENT_ID}"
          echo "  CLIENT_SECRET ê¸¸ì´: ${#GDRIVE_CLIENT_SECRET}"
          echo "  REFRESH_TOKEN ê¸¸ì´: ${#GDRIVE_REFRESH_TOKEN}"
          echo "  FOLDER_ID ê¸¸ì´: ${#GDRIVE_FOLDER_ID}"
          
          # ë¦¬í”„ë ˆì‹œ í† í°ì´ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
          if [ -z "$GDRIVE_REFRESH_TOKEN" ]; then
            echo "âŒ ì˜¤ë¥˜: GDRIVE_REFRESH_TOKENì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
            echo "ğŸ“ GitHub Secretsì— GDRIVE_REFRESH_TOKENì„ ì¶”ê°€í•˜ì„¸ìš”."
            exit 1
          fi
          
          # ë¦¬í”„ë ˆì‹œ í† í°ì´ CLIENT_SECRETê³¼ ê°™ì€ì§€ í™•ì¸ (ì˜ëª» ì„¤ì •ëœ ê²½ìš°)
          if [ "$GDRIVE_REFRESH_TOKEN" = "$GDRIVE_CLIENT_SECRET" ]; then
            echo "âŒ ì˜¤ë¥˜: REFRESH_TOKENì´ CLIENT_SECRETê³¼ ê°™ìŠµë‹ˆë‹¤!"
            echo "ğŸ“ GitHub Secretsì—ì„œ GDRIVE_REFRESH_TOKENì„ ì˜¬ë°”ë¥¸ ê°’ìœ¼ë¡œ ì„¤ì •í•˜ì„¸ìš”."
            echo "   ë¦¬í”„ë ˆì‹œ í† í°ì€ '1//'ë¡œ ì‹œì‘í•˜ëŠ” ê¸´ ë¬¸ìì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤."
            exit 1
          fi
          
          # ë¦¬í”„ë ˆì‹œ í† í°ì´ ì˜¬ë°”ë¥¸ í˜•ì‹ì¸ì§€ í™•ì¸ (1//ë¡œ ì‹œì‘í•´ì•¼ í•¨)
          if [[ ! "$GDRIVE_REFRESH_TOKEN" =~ ^1// ]]; then
            echo "âŒ ì˜¤ë¥˜: REFRESH_TOKEN í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤!"
            echo "ğŸ“ ë¦¬í”„ë ˆì‹œ í† í°ì€ '1//'ë¡œ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤."
            exit 1
          fi
          
          # rclone ì„¤ì • ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p ~/.config/rclone
          
          # ë°©ë²• 1: JSONì„ compact í˜•ì‹(ê³µë°± ì—†ì´)ìœ¼ë¡œ ì €ì¥í•˜ê³ , í† í°ì„ ë”°ì˜´í‘œë¡œ ê°ì‹¸ê¸°
          echo "ğŸ“ ë°©ë²• 1: Compact JSON + ë”°ì˜´í‘œë¡œ ê°ì‹¸ê¸° ì‹œë„ ì¤‘..."
          python3 -c "import os, json; token_json = {'access_token': '', 'token_type': 'Bearer', 'refresh_token': os.environ['GDRIVE_REFRESH_TOKEN'], 'expiry': '2000-01-01T00:00:00Z'}; token_json_str = json.dumps(token_json, separators=(',', ':')); config_path = os.path.expanduser('~/.config/rclone/rclone.conf'); config_content = f'[gdrive]\ntype = drive\nclient_id = {os.environ[\"GDRIVE_CLIENT_ID\"]}\nclient_secret = {os.environ[\"GDRIVE_CLIENT_SECRET\"]}\ntoken = \"{token_json_str}\"\nscope = drive.file\nroot_folder_id = {os.environ[\"GDRIVE_FOLDER_ID\"]}\n'; open(config_path, 'w').write(config_content); print('âœ… ë°©ë²• 1: ì„¤ì • íŒŒì¼ ìƒì„± ì™„ë£Œ')"
          
          # ì„¤ì • íŒŒì¼ ìƒì„± í™•ì¸ (ë³´ì•ˆ: ë¯¼ê°í•œ ì •ë³´ ë…¸ì¶œ ì—†ì´)
          if [ -f ~/.config/rclone/rclone.conf ]; then
            CONFIG_LINES=$(wc -l < ~/.config/rclone/rclone.conf)
            echo "âœ… ì„¤ì • íŒŒì¼ ìƒì„± í™•ì¸: $CONFIG_LINES ì¤„"
          else
            echo "âŒ ì˜¤ë¥˜: ì„¤ì • íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
            exit 1
          fi
          
          echo "âœ… OAuth ì„¤ì • ì™„ë£Œ (ë°©ë²• 1)"

      - name: Generate summary files (overwrite with details)
        run: |
          git log --pretty=format:"%h - %s (%an, %ad)" --date=short > Myteamdashboard_summary.txt
          git log --pretty=format:"%h - %s (%an, %ad)" --date=short > Myteamdashboard_summary_detail.txt
          echo -e "\n\n# ì „ì²´ ì½”ë“œ diff" >> Myteamdashboard_summary_detail.txt
          git diff $(git rev-list --max-parents=0 HEAD)..HEAD >> Myteamdashboard_summary_detail.txt

      - name: Upload summary file to Google Drive
        run: |
          # ë°©ë²• 1ë¡œ ì—…ë¡œë“œ ì‹œë„
          if rclone -v copyto Myteamdashboard_summary.txt gdrive:Myteamdashboard_summary.txt 2>&1 | grep -q "token expired\|no refresh token"; then
            echo "âš ï¸ ë°©ë²• 1 ì‹¤íŒ¨: í† í° ì¸ì‹ ì˜¤ë¥˜ ê°ì§€"
            echo "ğŸ“ ë°©ë²• 2: í† í°ì„ ë”°ì˜´í‘œ ì—†ì´ ì§ì ‘ ì €ì¥ ì‹œë„ ì¤‘..."
            
            # ë°©ë²• 2: í† í°ì„ ë”°ì˜´í‘œ ì—†ì´ ì§ì ‘ ì €ì¥ (compact JSON)
            python3 -c "import os, json; token_json = {'access_token': '', 'token_type': 'Bearer', 'refresh_token': os.environ['GDRIVE_REFRESH_TOKEN'], 'expiry': '2000-01-01T00:00:00Z'}; token_json_str = json.dumps(token_json, separators=(',', ':')); config_path = os.path.expanduser('~/.config/rclone/rclone.conf'); config_content = f'[gdrive]\ntype = drive\nclient_id = {os.environ[\"GDRIVE_CLIENT_ID\"]}\nclient_secret = {os.environ[\"GDRIVE_CLIENT_SECRET\"]}\ntoken = {token_json_str}\nscope = drive.file\nroot_folder_id = {os.environ[\"GDRIVE_FOLDER_ID\"]}\n'; open(config_path, 'w').write(config_content); print('âœ… ë°©ë²• 2: ì„¤ì • íŒŒì¼ ì¬ìƒì„± ì™„ë£Œ')"
            
            # ì„¤ì • íŒŒì¼ ì¬ìƒì„± í™•ì¸ (ë³´ì•ˆ: ë¯¼ê°í•œ ì •ë³´ ë…¸ì¶œ ì—†ì´)
            if [ -f ~/.config/rclone/rclone.conf ]; then
              CONFIG_LINES=$(wc -l < ~/.config/rclone/rclone.conf)
              echo "âœ… ì„¤ì • íŒŒì¼ ì¬ìƒì„± í™•ì¸: $CONFIG_LINES ì¤„"
            else
              echo "âŒ ì˜¤ë¥˜: ì„¤ì • íŒŒì¼ì´ ì¬ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
              exit 1
            fi
            
            # ë°©ë²• 2ë¡œ ì¬ì‹œë„
            rclone -v copyto Myteamdashboard_summary.txt gdrive:Myteamdashboard_summary.txt || {
              echo "âŒ ë°©ë²• 2ë„ ì‹¤íŒ¨: ì—…ë¡œë“œ ì‹¤íŒ¨"
              echo "ğŸ“ í•´ê²° ë°©ë²•:"
              echo "   1. Google Driveì—ì„œ í´ë”ë¥¼ ì—´ê³  'ê³µìœ ' í´ë¦­"
              echo "   2. Google ê³„ì • ì´ë©”ì¼ ì£¼ì†Œë¥¼ ê³µìœ ìë¡œ ì¶”ê°€ (í¸ì§‘ì ê¶Œí•œ)"
              echo "   3. GDRIVE_REFRESH_TOKENì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ì„¸ìš”"
              exit 1
            }
          else
            echo "âœ… ë°©ë²• 1ë¡œ ì—…ë¡œë“œ ì„±ê³µ"
          fi

      - name: Upload detailed summary file to Google Drive
        run: |
          # ë°©ë²• 1ë¡œ ì—…ë¡œë“œ ì‹œë„
          if rclone -v copyto Myteamdashboard_summary_detail.txt gdrive:Myteamdashboard_summary_detail.txt 2>&1 | grep -q "token expired\|no refresh token"; then
            echo "âš ï¸ ë°©ë²• 1 ì‹¤íŒ¨: í† í° ì¸ì‹ ì˜¤ë¥˜ ê°ì§€"
            echo "ğŸ“ ë°©ë²• 2: í† í°ì„ ë”°ì˜´í‘œ ì—†ì´ ì§ì ‘ ì €ì¥ ì‹œë„ ì¤‘..."
            
            # ë°©ë²• 2: í† í°ì„ ë”°ì˜´í‘œ ì—†ì´ ì§ì ‘ ì €ì¥ (compact JSON)
            python3 -c "import os, json; token_json = {'access_token': '', 'token_type': 'Bearer', 'refresh_token': os.environ['GDRIVE_REFRESH_TOKEN'], 'expiry': '2000-01-01T00:00:00Z'}; token_json_str = json.dumps(token_json, separators=(',', ':')); config_path = os.path.expanduser('~/.config/rclone/rclone.conf'); config_content = f'[gdrive]\ntype = drive\nclient_id = {os.environ[\"GDRIVE_CLIENT_ID\"]}\nclient_secret = {os.environ[\"GDRIVE_CLIENT_SECRET\"]}\ntoken = {token_json_str}\nscope = drive.file\nroot_folder_id = {os.environ[\"GDRIVE_FOLDER_ID\"]}\n'; open(config_path, 'w').write(config_content); print('âœ… ë°©ë²• 2: ì„¤ì • íŒŒì¼ ì¬ìƒì„± ì™„ë£Œ')"
            
            # ì„¤ì • íŒŒì¼ ì¬ìƒì„± í™•ì¸ (ë³´ì•ˆ: ë¯¼ê°í•œ ì •ë³´ ë…¸ì¶œ ì—†ì´)
            if [ -f ~/.config/rclone/rclone.conf ]; then
              CONFIG_LINES=$(wc -l < ~/.config/rclone/rclone.conf)
              echo "âœ… ì„¤ì • íŒŒì¼ ì¬ìƒì„± í™•ì¸: $CONFIG_LINES ì¤„"
            else
              echo "âŒ ì˜¤ë¥˜: ì„¤ì • íŒŒì¼ì´ ì¬ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
              exit 1
            fi
            
            # ë°©ë²• 2ë¡œ ì¬ì‹œë„
            rclone -v copyto Myteamdashboard_summary_detail.txt gdrive:Myteamdashboard_summary_detail.txt || {
              echo "âŒ ìƒì„¸ ìš”ì•½ íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨ (ë°©ë²• 2ë„ ì‹¤íŒ¨)"
              exit 1
            }
          else
            echo "âœ… ìƒì„¸ ìš”ì•½ íŒŒì¼ ì—…ë¡œë“œ ì„±ê³µ"
          fi

    env:
      GDRIVE_CLIENT_ID: ${{ secrets.GDRIVE_CLIENT_ID }}
      GDRIVE_CLIENT_SECRET: ${{ secrets.GDRIVE_CLIENT_SECRET }}
      GDRIVE_REFRESH_TOKEN: ${{ secrets.GDRIVE_REFRESH_TOKEN }}
      GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
