name: Push Summary to Google Drive

on:
  push:
    branches: [main]

jobs:
  drive-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Generate summary files
        run: |
          echo "\n---" >> Myteamdashboard_summary.txt
          echo "$(date '+%Y-%m-%d %H:%M')" >> Myteamdashboard_summary.txt
          git log -1 --pretty=format:"%h - %s (%an)" >> Myteamdashboard_summary.txt

          echo "\n---" >> Myteamdashboard_summary_detail.txt
          echo "$(date '+%Y-%m-%d %H:%M')" >> Myteamdashboard_summary_detail.txt
          git log -1 --pretty=format:"%h - %s (%an)" >> Myteamdashboard_summary_detail.txt
          echo -e "\nChanges:" >> Myteamdashboard_summary_detail.txt
          git diff HEAD^ >> Myteamdashboard_summary_detail.txt

      - name: Install rclone
        run: |
          sudo apt update && sudo apt install -y rclone

      - name: Configure rclone with service account
        run: |
          echo "$GDRIVE_CREDENTIALS" > credentials.json
          rclone config create gdrive drive scope=drive service_account_file=credentials.json

      - name: Upload summary file to Google Drive
        run: rclone copyto Myteamdashboard_summary.txt gdrive:${{ secrets.GDRIVE_FOLDER_ID }}/Myteamdashboard_summary.txt

      - name: Upload detailed summary file to Google Drive
        run: rclone copyto Myteamdashboard_summary_detail.txt gdrive:${{ secrets.GDRIVE_FOLDER_ID }}/Myteamdashboard_summary_detail.txt

    env:
      GDRIVE_CREDENTIALS: ${{ secrets.GDRIVE_CREDENTIALS }}
