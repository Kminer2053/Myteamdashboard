name: Push Summary to Google Drive

# ì›Œí¬í”Œë¡œìš° ë¹„í™œì„±í™” (í•„ìš”ì‹œ ì£¼ì„ í•´ì œ)
# on:
#   push:
#     branches: [main]
on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë§Œ ê°€ëŠ¥í•˜ë„ë¡ ë³€ê²½

jobs:
  drive-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout with full history
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install rclone
        run: |
          sudo apt update && sudo apt install -y rclone

      - name: Configure rclone with OAuth credentials
        run: |
          # OAuth 2.0ì„ ì‚¬ìš©í•˜ì—¬ ê°œì¸ Google ê³„ì • ê¶Œí•œìœ¼ë¡œ ì—…ë¡œë“œ
          echo "ğŸ” OAuth 2.0 ëª¨ë“œë¡œ ì„¤ì • ì¤‘..."
          
          # í™˜ê²½ ë³€ìˆ˜ í™•ì¸ (ë””ë²„ê¹…ìš©)
          echo "ğŸ“‹ í™˜ê²½ ë³€ìˆ˜ í™•ì¸:"
          echo "  CLIENT_ID ê¸¸ì´: ${#GDRIVE_CLIENT_ID}"
          echo "  CLIENT_SECRET ê¸¸ì´: ${#GDRIVE_CLIENT_SECRET}"
          echo "  REFRESH_TOKEN ê¸¸ì´: ${#GDRIVE_REFRESH_TOKEN}"
          echo "  REFRESH_TOKEN ì‹œì‘: ${GDRIVE_REFRESH_TOKEN:0:10}..."
          echo "  FOLDER_ID: $GDRIVE_FOLDER_ID"
          
          # ë¦¬í”„ë ˆì‹œ í† í°ì´ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
          if [ -z "$GDRIVE_REFRESH_TOKEN" ]; then
            echo "âŒ ì˜¤ë¥˜: GDRIVE_REFRESH_TOKENì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
            echo "ğŸ“ GitHub Secretsì— GDRIVE_REFRESH_TOKENì„ ì¶”ê°€í•˜ì„¸ìš”."
            exit 1
          fi
          
          # ë¦¬í”„ë ˆì‹œ í† í°ì´ CLIENT_SECRETê³¼ ê°™ì€ì§€ í™•ì¸ (ì˜ëª» ì„¤ì •ëœ ê²½ìš°)
          if [ "$GDRIVE_REFRESH_TOKEN" = "$GDRIVE_CLIENT_SECRET" ]; then
            echo "âŒ ì˜¤ë¥˜: REFRESH_TOKENì´ CLIENT_SECRETê³¼ ê°™ìŠµë‹ˆë‹¤!"
            echo "ğŸ“ GitHub Secretsì—ì„œ GDRIVE_REFRESH_TOKENì„ ì˜¬ë°”ë¥¸ ê°’ìœ¼ë¡œ ì„¤ì •í•˜ì„¸ìš”."
            echo "   ë¦¬í”„ë ˆì‹œ í† í°ì€ '1//'ë¡œ ì‹œì‘í•˜ëŠ” ê¸´ ë¬¸ìì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤."
            exit 1
          fi
          
          # ë¦¬í”„ë ˆì‹œ í† í°ì´ ì˜¬ë°”ë¥¸ í˜•ì‹ì¸ì§€ í™•ì¸ (1//ë¡œ ì‹œì‘í•´ì•¼ í•¨)
          if [[ ! "$GDRIVE_REFRESH_TOKEN" =~ ^1// ]]; then
            echo "âŒ ì˜¤ë¥˜: REFRESH_TOKEN í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤!"
            echo "ğŸ“ ë¦¬í”„ë ˆì‹œ í† í°ì€ '1//'ë¡œ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤."
            echo "   í˜„ì¬ ê°’ ì‹œì‘: ${GDRIVE_REFRESH_TOKEN:0:10}..."
            exit 1
          fi
          
          # rclone ì„¤ì • ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p ~/.config/rclone
          
          # í† í° JSON ë¬¸ìì—´ ìƒì„± (ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬)
          # rcloneì€ í† í°ì„ JSON ë¬¸ìì—´ë¡œ ì €ì¥í•´ì•¼ í•¨
          TOKEN_JSON="{\"access_token\":\"\",\"token_type\":\"Bearer\",\"refresh_token\":\"$GDRIVE_REFRESH_TOKEN\",\"expiry\":\"2000-01-01T00:00:00Z\"}"
          
          # rclone ì„¤ì • íŒŒì¼ ì§ì ‘ ìƒì„±
          echo "ğŸ“ rclone ì„¤ì • íŒŒì¼ ìƒì„± ì¤‘..."
          {
            echo "[gdrive]"
            echo "type = drive"
            echo "client_id = $GDRIVE_CLIENT_ID"
            echo "client_secret = $GDRIVE_CLIENT_SECRET"
            # í† í°ì€ JSON ë¬¸ìì—´ë¡œ ì €ì¥ (rcloneì´ ìë™ìœ¼ë¡œ íŒŒì‹±)
            echo "token = $TOKEN_JSON"
            echo "scope = drive.file"
            echo "root_folder_id = $GDRIVE_FOLDER_ID"
          } > ~/.config/rclone/rclone.conf
          
          # ì„¤ì • íŒŒì¼ ê²€ì¦
          echo "ğŸ” ì„¤ì • íŒŒì¼ ê²€ì¦ ì¤‘..."
          if ! grep -q "refresh_token" ~/.config/rclone/rclone.conf; then
            echo "âŒ ì˜¤ë¥˜: refresh_tokenì´ ì„¤ì • íŒŒì¼ì— ì—†ìŠµë‹ˆë‹¤!"
            exit 1
          fi
          
          echo "âœ… OAuth ì„¤ì • ì™„ë£Œ"
          echo "ğŸ“‹ ì„¤ì • íŒŒì¼ í™•ì¸:"
          cat ~/.config/rclone/rclone.conf | grep -v "token\|secret" || true

      - name: Generate summary files (overwrite with details)
        run: |
          git log --pretty=format:"%h - %s (%an, %ad)" --date=short > Myteamdashboard_summary.txt
          git log --pretty=format:"%h - %s (%an, %ad)" --date=short > Myteamdashboard_summary_detail.txt
          echo -e "\n\n# ì „ì²´ ì½”ë“œ diff" >> Myteamdashboard_summary_detail.txt
          git diff $(git rev-list --max-parents=0 HEAD)..HEAD >> Myteamdashboard_summary_detail.txt

      - name: Upload summary file to Google Drive
        run: |
          rclone -v copyto Myteamdashboard_summary.txt gdrive:Myteamdashboard_summary.txt || {
            echo "âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: Service Accountì— í´ë” ì ‘ê·¼ ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”."
            echo "ğŸ“ í•´ê²° ë°©ë²•:"
            echo "   1. Google Driveì—ì„œ í´ë”ë¥¼ ì—´ê³  'ê³µìœ ' í´ë¦­"
            echo "   2. Service Account ì´ë©”ì¼ ì£¼ì†Œë¥¼ ê³µìœ ìë¡œ ì¶”ê°€ (í¸ì§‘ì ê¶Œí•œ)"
            echo "   3. ë˜ëŠ” Shared Driveë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš° GDRIVE_TEAM_DRIVE_ID secretì„ ì„¤ì •í•˜ì„¸ìš”"
            exit 1
          }

      - name: Upload detailed summary file to Google Drive
        run: |
          rclone -v copyto Myteamdashboard_summary_detail.txt gdrive:Myteamdashboard_summary_detail.txt || {
            echo "âŒ ìƒì„¸ ìš”ì•½ íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨"
            exit 1
          }

    env:
      GDRIVE_CLIENT_ID: ${{ secrets.GDRIVE_CLIENT_ID }}
      GDRIVE_CLIENT_SECRET: ${{ secrets.GDRIVE_CLIENT_SECRET }}
      GDRIVE_REFRESH_TOKEN: ${{ secrets.GDRIVE_REFRESH_TOKEN }}
      GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
